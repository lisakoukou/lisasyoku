<!DOCTYPE html>
<html lang="ja">
<head>
  </head>
<body>

  <h1>äºˆç´„å®Œäº† ğŸŠ</h1>
  <div id="message-box"></div>

  <div class="details">
    <h2>ç¢ºå®šã—ãŸäºˆç´„å†…å®¹</h2>
    <p><strong>åå‰ï¼š</strong><span id="displayName"></span></p>
    <p><strong>ãƒ¡ãƒ¼ãƒ«ï¼š</strong><span id="displayEmail"></span></p>
    <p><strong>æ¥è¨ªæ™‚åˆ»ï¼š</strong><span id="displayTime"></span></p>
    <p><strong>äººæ•°ï¼ˆå¸­æ•°ï¼‰ï¼š</strong><span id="displayPeople"></span></p>
    <p><strong>äºˆç´„å¸­ï¼š</strong><span id="displaySeats">å‡¦ç†ä¸­...</span></p>
  </div>

  <button class="back-button" onclick="window.location.href='index.html'">å¸­ãƒãƒƒãƒ—ã«æˆ»ã‚‹</button>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    // updateã‚’æ˜ç¤ºçš„ã«ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
    import { getDatabase, ref, update, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAPh0iGqnlJDPakQDTrpStt7_WV1gaVvBs",
      authDomain: "lisasyokudo.firebaseapp.com",
      databaseURL: "https://lisasyokudo-default-rtdb.asia-southeast1.firebaserestapi.com", // ä¿®æ­£å¾Œã®Database URLã‚’ä½¿ç”¨
      projectId: "lisasyokudo",
      storageBucket: "lisasyokudo.firebasestorage.app",
      messagingSenderId: "94391681633",
      appId: "1:94391681633:web:515d6d17c9567e153b2020",
      measurementId: "G-HBNXQBQ4PR"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const seatsRef = ref(db, 'seats'); 
    
    const messageBox = document.getElementById('message-box');
    const displaySeats = document.getElementById("displaySeats");
    
    const params = new URLSearchParams(window.location.search);
    const name = params.get("name") ?? "ä¸æ˜";
    const email = params.get("email") ?? "ä¸æ˜";
    const time = params.get("time") ?? "ä¸æ˜";
    const people = params.get("people") ?? "0";

    document.getElementById("displayName").textContent = name;
    document.getElementById("displayEmail").textContent = email;
    document.getElementById("displayTime").textContent = time;
    document.getElementById("displayPeople").textContent = people;

    const finalizingSeatsJson = localStorage.getItem('finalizingReservationSeats');
    const finalizingSeats = JSON.parse(finalizingSeatsJson || '[]');
    
    if (finalizingSeats.length > 0) {
        displaySeats.textContent = finalizingSeats.join(', ');
        
        const updates = {};
        finalizingSeats.forEach(seatKey => {
            // isTempã‚’falseï¼ˆç¢ºå®šäºˆç´„ï¼‰ã«ã—ã€timestampã‚’æ›´æ–°
            updates[seatKey + '/isTemp'] = false;
            updates[seatKey + '/timestamp'] = serverTimestamp();
            // æ³¨æ„: isOccupiedã¯æ—¢ã«trueãªã®ã§ã€å¤‰æ›´ä¸è¦
        });
        
        update(seatsRef, updates)
            .then(() => {
                messageBox.textContent = 'ğŸ‰ äºˆç´„ãŒæ­£å¸¸ã«ç¢ºå®šã•ã‚Œã¾ã—ãŸï¼';
                localStorage.removeItem('finalizingReservationSeats');
            })
            .catch(error => {
                console.error("Reservation finalization failed:", error);
                messageBox.style.backgroundColor = '#e74c3c';
                messageBox.textContent = 'âŒ äºˆç´„ç¢ºå®šå‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚å¸­ãƒãƒƒãƒ—ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
            });
    } else {
        messageBox.style.backgroundColor = '#e74c3c';
        messageBox.textContent = 'âŒ ç¢ºå®šã™ã¹ãäºˆç´„æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚';
        displaySeats.textContent = 'ãªã—';
    }

  </script>

</body>
</html>

