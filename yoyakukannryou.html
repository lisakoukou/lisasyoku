<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>äºˆç´„å®Œäº† - ç‹ã®é£Ÿå ‚</title>
  <style>
    body {
      font-family: "æ¸¸ã‚´ã‚·ãƒƒã‚¯", sans-serif;
      background-color: #f9f9f9;
      padding: 1rem;
      margin: 0;
      text-align: center;
    }

    h1 {
      color: #008000;
      font-size: 2rem;
      margin-bottom: 0.5rem;
    }

    p {
      font-size: 1.1rem;
      margin: 0.5rem 0;
    }

    .details {
      background-color: #e6ffe6;
      border: 1px solid #c3e6cb;
      padding: 1.2rem;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      margin: 2rem auto;
      max-width: 500px;
      text-align: left;
    }

    .details h2 {
      text-align: center;
      font-size: 1.3rem;
      margin-bottom: 1rem;
    }

    .details p {
      font-size: 1rem;
      margin: 0.6rem 0;
    }
    
    #message-box {
        margin-top: 1rem;
        padding: 0.75rem;
        border-radius: 4px;
        color: white;
        background-color: #2ecc71;
        text-align: center;
        font-weight: bold;
    }

    .back-button {
      background-color: #008000;
      color: white;
      padding: 0.75rem 1rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
      margin-top: 1rem;
    }

    .back-button:hover {
      background-color: #006400;
    }

    @media (max-width: 480px) {
      h1 {
        font-size: 1.5rem;
      }

      .details {
        padding: 1rem;
        margin: 1rem;
      }

      .details h2 {
        font-size: 1.1rem;
      }

      .details p {
        font-size: 0.95rem;
      }

      .back-button {
        width: 100%;
        font-size: 1rem;
      }
    }
  </style>
</head>
<body>

  <h1>äºˆç´„å®Œäº† ğŸŠ</h1>
  <div id="message-box"></div>

  <div class="details">
    <h2>ç¢ºå®šã—ãŸäºˆç´„å†…å®¹</h2>
    <p><strong>åå‰ï¼š</strong><span id="displayName"></span></p>
    <p><strong>ãƒ¡ãƒ¼ãƒ«ï¼š</strong><span id="displayEmail"></span></p>
    <p><strong>æ¥è¨ªæ™‚åˆ»ï¼š</strong><span id="displayTime"></span></p>
    <p><strong>äººæ•°ï¼ˆå¸­æ•°ï¼‰ï¼š</strong><span id="displayPeople"></span></p>
    <p><strong>äºˆç´„å¸­ï¼š</strong><span id="displaySeats">å‡¦ç†ä¸­...</span></p>
  </div>

  <button class="back-button" onclick="window.location.href='index.html'">å¸­ãƒãƒƒãƒ—ã«æˆ»ã‚‹</button>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import { getDatabase, ref, update, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAPh0iGqnlJDPakQDTrpStt7_WV1gaVvBs",
      authDomain: "lisasyokudo.firebaseapp.com",
      databaseURL: "https://lisasyokudo-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "lisasyokudo",
      storageBucket: "lisasyokudo.firebasestorage.app",
      messagingSenderId: "94391681633",
      appId: "1:94391681633:web:515d6d17c9567e153b2020",
      measurementId: "G-HBNXQBQ4PR"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const seatsRef = ref(db, 'seats'); 
    
    const messageBox = document.getElementById('message-box');
    const displaySeats = document.getElementById("displaySeats");
    
    const params = new URLSearchParams(window.location.search);
    const name = params.get("name") ?? "ä¸æ˜";
    const email = params.get("email") ?? "ä¸æ˜";
    const time = params.get("time") ?? "ä¸æ˜";
    const people = params.get("people") ?? "0";

    document.getElementById("displayName").textContent = name;
    document.getElementById("displayEmail").textContent = email;
    document.getElementById("displayTime").textContent = time;
    document.getElementById("displayPeople").textContent = people;

    const finalizingSeatsJson = localStorage.getItem('finalizingReservationSeats');
    const finalizingSeats = JSON.parse(finalizingSeatsJson || '[]');
    
    if (finalizingSeats.length > 0) {
        displaySeats.textContent = finalizingSeats.join(', ');
        
        const updates = {};
        finalizingSeats.forEach(seatKey => {
            // ä¿®æ­£1: isTemp ã‚’ false ã«è¨­å®š
            updates[seatKey + '/isTemp'] = false;
            // ä¿®æ­£2: timestamp ã‚’æ›´æ–°ï¼ˆæœ€çµ‚ç¢ºå®šæ™‚åˆ»ã¨ã—ã¦ï¼‰
            updates[seatKey + '/timestamp'] = serverTimestamp(); 
        });
        
        update(seatsRef, updates)
            .then(() => {
                messageBox.textContent = 'ğŸ‰ äºˆç´„ãŒæ­£å¸¸ã«ç¢ºå®šã•ã‚Œã¾ã—ãŸï¼';
                localStorage.removeItem('finalizingReservationSeats');
            })
            .catch(error => {
                console.error("Reservation finalization failed:", error);
                messageBox.style.backgroundColor = '#e74c3c';
                messageBox.textContent = 'âŒ äºˆç´„ç¢ºå®šå‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚å¸­ãƒãƒƒãƒ—ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
            });
    } else {
        messageBox.style.backgroundColor = '#e74c3c';
        messageBox.textContent = 'âŒ ç¢ºå®šã™ã¹ãäºˆç´„æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚';
        displaySeats.textContent = 'ãªã—';
    }

  </script>

</body>
</html>

