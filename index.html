<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=1100" />
  <title>ç‹ã®é£Ÿå ‚ äºˆç´„ã‚·ã‚¹ãƒ†ãƒ </title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: 'Helvetica Neue', Arial, sans-serif;
      background-color: #f4f1ea;
      color: #4a4a4a;
      padding: 40px 20px;
    }
    /* å…¨ä½“ã‚’ä¸­å¤®ã«å¯„ã›ã‚‹è¨­å®š */
    .main-wrapper {
      max-width: 1100px;
      margin: 0 auto;
      text-align: center;
    }
    /* ã‚¿ã‚¤ãƒˆãƒ«ã¨ãƒœã‚¿ãƒ³ã‚’ç‰¹å¤§ã«ã™ã‚‹ï¼ˆã‚¹ãƒãƒ›ã§ã®è¦–èªæ€§å‘ä¸Šï¼‰ */
    .header-title { font-size: 4rem; font-weight: 900; margin-bottom: 2rem; color: #333; }
    .nav-button {
      display: inline-block; padding: 2rem 4rem; font-size: 1.8rem;
      font-weight: bold; background-color: #ff7043; color: white;
      border-radius: 9999px; box-shadow: 0 10px 25px rgba(255, 112, 67, 0.4);
      transition: 0.3s; text-decoration: none;
    }
    
    /* åº§å¸­è¡¨ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼ˆPCã§ä¸­å¤®ã€ã‚¹ãƒãƒ›ã§å…¨ä½“è¡¨ç¤ºï¼‰ */
    .columns {
      display: flex;
      justify-content: center;
      gap: 40px;
      margin-top: 40px;
      padding-bottom: 150px; /* ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ç”¨ã®ä½™ç™½ */
    }
    .column { display: flex; flex-direction: column; gap: 30px; width: 320px; }
    
    .table-block {
      background: white; padding: 25px 20px; border-radius: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.08); display: flex; flex-direction: column; align-items: center; gap: 15px;
    }
    .seat-row { display: flex; gap: 12px; }
    .seat {
      width: 48px; height: 48px; border-radius: 50%; background-color: #37474f;
      color: white; font-weight: bold; font-size: 18px; line-height: 48px; text-align: center;
      position: relative; transition: 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    .seat.occupied { background-color: #66bb6a; }
    .seat.mine-temp { background-color: #ffa726; border: 3px solid #e65100; }
    .seat.mine-final { background-color: #29b6f6; }
    .seat.temp-reserved { background-color: #ffcc80; color: #5d4037; opacity: 0.8; }
    
    .table {
      width: 160px; height: 50px; background-color: #d7ccc8; border-radius: 8px;
      line-height: 50px; font-weight: bold; font-size: 1.2rem; color: #5d4037;
    }

    /* ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ï¼ˆå¤§ããè¡¨ç¤ºï¼‰ */
    .tooltip {
        visibility: hidden; background-color: rgba(33, 33, 33, 0.98); color: #fff;
        border-radius: 12px; padding: 12px 20px; position: absolute; z-index: 100;
        top: 130%; left: 50%; transform: translateX(-50%); white-space: nowrap;
        opacity: 0; transition: 0.3s; font-size: 16px; pointer-events: none;
    }
    .seat:hover .tooltip { visibility: visible; opacity: 1; top: 115%; }

    /* ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ï¼ˆæ–‡å­—ã‚’å¤§ããï¼‰ */
    #modal-overlay {
        display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8);
        z-index: 2000; justify-content: center; align-items: center; padding: 40px;
    }
    .modal-content {
        background: white; padding: 3rem; border-radius: 30px; max-width: 600px; width: 100%;
        text-align: center; font-size: 1.5rem;
    }
  </style>
</head>
<body>
<div class="main-wrapper">

    <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-95 flex justify-center items-center flex-col z-[3000]">
        <div class="animate-spin rounded-full h-24 w-24 border-t-8 border-orange-500"></div>
        <p class="mt-6 text-2xl text-orange-600 font-bold">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
    </div>

    <div id="modal-overlay">
        <div class="modal-content">
            <div class="text-6xl mb-6">âš ï¸</div>
            <h3 id="modal-title" class="text-3xl font-bold mb-4">ç¢ºèª</h3>
            <p id="modal-body" class="text-gray-600 mb-8"></p>
            <button onclick="closeModal()" class="w-full py-5 bg-orange-500 text-white text-2xl font-bold rounded-2xl">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <h1 class="header-title tracking-tighter">ğŸ› é£Ÿå ‚åº§å¸­äºˆç´„</h1>

    <div class="mb-10">
        <a href="yoyaku.html" class="nav-button">äºˆç´„è€…æƒ…å ±ã‚’å…¥åŠ›ãƒ»å¤‰æ›´ã™ã‚‹</a>
    </div>

    <div id="user-info" class="mb-8 p-8 bg-white border-l-[12px] border-blue-500 rounded-2xl shadow-lg text-2xl text-left"></div>

    <div id="admin-area" class="mb-8 text-right hidden">
        <button id="reset-seats-button" class="bg-red-700 text-white font-bold py-3 px-8 rounded-full text-xl shadow-lg">ğŸš¨ ç®¡ç†è€…: å…¨å¸­ãƒªã‚»ãƒƒãƒˆ</button>
    </div>

    <div id="reservation-action" class="bg-orange-50 border-4 border-orange-200 p-8 rounded-[40px] shadow-2xl mb-12 hidden">
        <div class="flex items-center justify-between gap-6">
            <div class="text-left">
                <p class="text-3xl font-black text-orange-800">ä»®äºˆç´„ä¸­: <span id="temp-reserved-count" class="text-6xl text-orange-600">0</span> å¸­</p>
                <p class="text-xl text-orange-600 font-bold mt-2">â€»10åˆ†ä»¥å†…ã«ç¢ºå®šã—ã¦ãã ã•ã„</p>
            </div>
            <button id="confirm-reservation-button" class="bg-gradient-to-r from-red-500 to-pink-600 text-white text-3xl font-black py-8 px-16 rounded-3xl shadow-2xl transform active:scale-95 transition-all">äºˆç´„ã‚’ç¢ºå®šã™ã‚‹</button>
        </div>
    </div>

    <div class="bg-white p-8 rounded-3xl shadow-md mb-10 inline-flex items-center space-x-12 text-3xl">
        <p>ãƒã‚¤äºˆç´„: <span id="reserved-count" class="font-black text-orange-600">0</span> / 6</p>
        <div class="h-16 w-1 bg-gray-200"></div>
        <p>ç·ç¢ºå®š: <span id="total-occupied-count" class="font-black text-green-600">0</span> / 171</p>
    </div>

    <div class="columns">
        <div class="column" id="left-column"></div>
        <div class="column" id="middle-column"></div>
        <div class="column" id="right-column"></div>
    </div>

</div>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
  import { getDatabase, ref, onValue, runTransaction, serverTimestamp, set, remove } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js";
  
  const firebaseConfig = {
    apiKey: "AIzaSyAPh0iGqnlJDPakQDTrpStt7_WV1gaVvBs",
    authDomain: "lisasyokudo.firebaseapp.com",
    databaseURL: "https://lisasyokudo-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "lisasyokudo",
    storageBucket: "lisasyokudo.firebasestorage.app",
    messagingSenderId: "94391681633",
    appId: "1:94391681633:web:515d6d17c9567e153b2020"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const seatsRef = ref(db, 'seats'); 
  const TEMP_LIMIT_MS = 10 * 60 * 1000; 

  let currentUserDetails = JSON.parse(localStorage.getItem('currentUserDetails') || 'null');
  const currentUserEmail = currentUserDetails ? currentUserDetails.email.trim().toLowerCase() : null; 
  const ADMIN_EMAIL = '0116zst24115a7e8@gl.pen-kanagawa.ed.jp'.toLowerCase();
  let seatsData = {};

  // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—åˆ¶å¾¡
  window.showModal = (title, body) => {
      document.getElementById('modal-title').innerText = title;
      document.getElementById('modal-body').innerText = body;
      document.getElementById('modal-overlay').style.display = 'flex';
  };
  window.closeModal = () => {
      document.getElementById('modal-overlay').style.display = 'none';
  };

  // 10åˆ†çµŒéã—ãŸä»®äºˆç´„ã‚’è‡ªå‹•å‰Šé™¤
  function cleanupExpiredReservations() {
      const now = Date.now();
      Object.keys(seatsData).forEach(key => {
          const info = seatsData[key];
          if (info.isTemp && info.timestamp && (now - info.timestamp > TEMP_LIMIT_MS)) {
              remove(ref(db, `seats/${key}`));
          }
      });
  }

  function updateUserInfoDisplay() {
    const infoDiv = document.getElementById('user-info');
    if (currentUserDetails) {
        const isAdmin = currentUserEmail === ADMIN_EMAIL;
        infoDiv.innerHTML = `<p class="font-bold text-blue-600 mb-2">ç¾åœ¨ã®äºˆç´„è€…</p><div class="flex items-baseline gap-4"><span class="text-4xl font-black">${currentUserDetails.name}</span><span class="text-gray-500 text-xl">${currentUserEmail}</span></div>${isAdmin ? '<p class="text-red-500 font-bold mt-2">[ç®¡ç†è€…æ¨©é™æœ‰åŠ¹]</p>' : ''}`;
        if (isAdmin) document.getElementById('admin-area').style.display = 'block';
    } else {
        infoDiv.innerHTML = `<p class="text-red-500 font-bold">äºˆç´„è€…æƒ…å ±ãŒæœªè¨­å®šã§ã™</p><p class="text-lg text-gray-500">ä¸Šã®ã‚ªãƒ¬ãƒ³ã‚¸è‰²ã®ãƒœã‚¿ãƒ³ã‹ã‚‰ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚</p>`;
    }
  }

  function toggleSeatStatus(tableNum, seatIndex) {
    if (!currentUserEmail) { 
        showModal("äºˆç´„æƒ…å ±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", "åº§å¸­ã‚’äºˆç´„ã™ã‚‹ã«ã¯ã€ã¾ãšãŠåå‰ã¨ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ç™»éŒ²ãŒå¿…è¦ã§ã™ã€‚");
        return; 
    }
    const seatKey = `T${tableNum + 1}-S${seatIndex + 1}`;
    const seatRef = ref(db, 'seats/' + seatKey);
    runTransaction(seatRef, (current) => {
      if (current && current.isOccupied && current.reservedByEmail !== currentUserEmail) return;
      if (current && current.isTemp === false) return; 
      if (current && current.isTemp === true) return null; 
      const myCount = Object.values(seatsData).filter(s => s.reservedByEmail === currentUserEmail).length;
      if (!current && myCount >= 6) return;
      return { isOccupied: true, isTemp: true, reservedByEmail: currentUserEmail, reservedByName: currentUserDetails.name, timestamp: serverTimestamp() };
    });
  }

  function createSeat(seatIndex, tableNum) {
    const seatKey = `T${tableNum + 1}-S${seatIndex + 1}`;
    const info = seatsData[seatKey];
    const isOccupied = info && info.isOccupied;
    const isMine = isOccupied && info.reservedByEmail === currentUserEmail;
    const isAdmin = currentUserEmail === ADMIN_EMAIL;
    
    const div = document.createElement("div");
    div.className = "seat";
    div.innerText = seatIndex + 1;
    if (isMine) div.classList.add("occupied", info.isTemp ? "mine-temp" : "mine-final");
    else if (isOccupied) div.classList.add(info.isTemp ? "temp-reserved" : "occupied");

    const canClick = !isOccupied || (isMine && info.isTemp === true);
    if (canClick) {
        div.onclick = () => toggleSeatStatus(tableNum, seatIndex);
        div.style.cursor = "pointer";
    } else { div.style.cursor = "not-allowed"; }

    if (isOccupied) {
        const tip = document.createElement("span");
        tip.className = "tooltip shadow-2xl border border-gray-300";
        const emailLine = isAdmin ? `<br><span class="text-xs text-gray-400 font-normal">${info.reservedByEmail}</span>` : "";
        tip.innerHTML = `<strong>${info.isTemp ? 'â³ä»®äºˆç´„' : 'âœ…ç¢ºå®š'}</strong><br><span class="text-xl font-bold">${info.reservedByName}</span>${emailLine}`;
        div.appendChild(tip);
    }
    return div;
  }

  function createTableBlock(tableNum) {
    const block = document.createElement("div");
    block.className = "table-block";
    const seatsTop = document.createElement("div");
    seatsTop.className = "seat-row";
    const tableDiv = document.createElement("div");
    tableDiv.className = "table";
    tableDiv.innerText = `æœº ${tableNum + 1}`;

    if (tableNum === 28) { // æœº29ï¼šä¸Š3å¸­ã®ã¿
        for (let i = 0; i < 3; i++) seatsTop.appendChild(createSeat(i, tableNum));
        block.appendChild(seatsTop);
        block.appendChild(tableDiv);
    } else {
        for (let i = 0; i < 3; i++) seatsTop.appendChild(createSeat(i, tableNum));
        block.appendChild(seatsTop);
        block.appendChild(tableDiv);
        const seatsBottom = document.createElement("div");
        seatsBottom.className = "seat-row";
        for (let i = 3; i < 6; i++) seatsBottom.appendChild(createSeat(i, tableNum));
        block.appendChild(seatsBottom);
    }
    return block;
  }

  function render() {
    const cols = [document.getElementById("left-column"), document.getElementById("middle-column"), document.getElementById("right-column")];
    cols.forEach(c => c.innerHTML = "");
    let tIdx = 0;
    const counts = [7, 10, 12];
    counts.forEach((count, cIdx) => {
      for (let i = 0; i < count; i++) cols[cIdx].appendChild(createTableBlock(tIdx++));
    });
    const all = Object.values(seatsData);
    document.getElementById("reserved-count").textContent = all.filter(s => s.reservedByEmail === currentUserEmail).length;
    document.getElementById("total-occupied-count").textContent = all.filter(s => !s.isTemp).length;
    const temps = Object.keys(seatsData).filter(k => seatsData[k].reservedByEmail === currentUserEmail && seatsData[k].isTemp);
    document.getElementById('reservation-action').style.display = temps.length > 0 ? 'flex' : 'none';
    document.getElementById("temp-reserved-count").textContent = temps.length;
  }

  onValue(seatsRef, (snap) => {
    document.getElementById("loading-overlay").style.display = 'none';
    seatsData = snap.val() || {};
    cleanupExpiredReservations();
    render();
  });

  setInterval(cleanupExpiredReservations, 60000);

  document.getElementById('confirm-reservation-button').onclick = () => {
      const temps = Object.keys(seatsData).filter(k => seatsData[k].reservedByEmail === currentUserEmail && seatsData[k].isTemp);
      localStorage.setItem('finalizingReservationSeats', JSON.stringify(temps));
      window.location.href = `yoyakukannryou.html?name=${encodeURIComponent(currentUserDetails.name)}&email=${encodeURIComponent(currentUserEmail)}&people=${temps.length}`;
  };
  
  document.getElementById('reset-seats-button').onclick = async () => {
      if (confirm("å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã€‚æœ¬å½“ã«ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) {
          await set(seatsRef, null);
      }
  };

  updateUserInfoDisplay();
</script>
</body>
</html>
